<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ParteKARTu</title>

    <script src="js/i18n.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
        }

        .card-dark {
            background-color: #1e293b;
            border: 1px solid #334155;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            border-top: 1px solid #334155;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 50;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        .nav-bar button {
            min-height: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .nav-bar button i,
        .nav-bar button span {
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 0.75rem;
            background: #0f172a;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .has-trips {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .driving-day {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.2) !important;
            color: #10b981;
            font-weight: 900;
        }

        .selected-day {
            background: #6366f1 !important;
            color: white;
            border-color: white;
        }

        .day-past {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .toast-confirm {
            position: fixed;
            top: env(safe-area-inset-top, 20px);
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 10px;
            text-transform: uppercase;
            z-index: 100;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translate(-50%, -100%);
            }

            to {
                transform: translate(-50%, 0);
            }
        }

        /* Evitar que se vea blanco mientras carga */
        #auth-screen:not(.hidden) {
            display: flex !important;
        }

        /* Estilos mejorados para selects */
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236366f1' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem !important;
            transition: all 0.2s;
        }

        select:hover {
            background-color: #0f172a;
            border: 1px solid #6366f1;
        }

        select:focus {
            outline: 2px solid #6366f1;
            outline-offset: 2px;
        }

        select option {
            background-color: #1e293b;
            color: #f8fafc;
            padding: 12px;
        }

        /* Botones seleccionables */
        .btn-selector {
            background-color: #1e293b;
            color: #94a3b8;
            border: 2px solid #334155;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-selector:hover {
            border-color: #6366f1;
            color: #e0e7ff;
        }

        .btn-selector.active {
            background-color: #4f46e5 !important;
            color: white !important;
            border-color: #6366f1 !important;
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.4);
        }
    </style>
</head>

<body class="pb-32">

    <div id="loading-overlay" class="fixed inset-0 bg-slate-950 flex items-center justify-center z-[100]">
        <div class="text-indigo-500 animate-pulse font-black italic text-xl">ParteKARTu...</div>
    </div>

    <div id="auth-screen" class="hidden min-h-screen flex-col items-center justify-center p-6">
        <h1 class="text-4xl font-black italic mb-8 tracking-tighter text-indigo-500">ParteKARTu</h1>
        <div class="w-full max-w-sm card-dark p-8 rounded-[2.5rem] space-y-4 shadow-2xl">
            <input type="email" id="email" class="w-full p-4 bg-slate-900 rounded-2xl border-none text-white text-sm"
                placeholder="Email">
            <input type="password" id="password"
                class="w-full p-4 bg-slate-900 rounded-2xl border-none text-white text-sm" placeholder="Contraseña">
            <button id="btn-login"
                class="w-full bg-indigo-600 py-4 rounded-2xl font-black uppercase text-xs tracking-widest">Entrar /
                Registro</button>
        </div>
    </div>

    <main id="app-content" class="hidden p-4 max-w-md mx-auto pt-4">
        <section id="tab-inicio" class="space-y-6">
            <h2 class="text-2xl font-black italic" data-i18n="title_inicio">Inicio</h2>
            <div class="card-dark p-6 rounded-[2rem] border-b-4 border-green-500 space-y-4 shadow-lg">
                <p class="text-[10px] font-black text-slate-500 uppercase" data-i18n="label_new_group">Nuevo Grupo</p>
                <input type="text" id="new-group-name"
                    class="w-full p-3 bg-slate-900 rounded-xl text-sm text-center font-bold uppercase"
                    placeholder="Nombre del grupo" data-i18n="placeholder_group_name">
                <button onclick="createGroup()" class="w-full bg-green-600 py-3 rounded-xl font-black text-xs uppercase"
                    data-i18n="btn_create_group">Crear Grupo</button>
            </div>
            <div class="card-dark p-6 rounded-[2rem] border-b-4 border-indigo-500 space-y-4 shadow-lg">
                <p class="text-[10px] font-black text-slate-500 uppercase" data-i18n="label_join_group">Unirse a Grupo
                </p>
                <input type="text" id="join-code"
                    class="w-full p-3 bg-slate-900 rounded-xl text-sm text-center font-bold uppercase"
                    placeholder="CÓDIGO" data-i18n="placeholder_join_code">
                <button id="btn-join-group" onclick="joinGroup()"
                    class="w-full bg-indigo-600 py-3 rounded-xl font-black text-xs uppercase"
                    data-i18n="btn_join">Unirse</button>
            </div>
        </section>

        <section id="tab-grupos" class="hidden space-y-4">
            <div id="view-groups-list" class="space-y-3 text-center">
                <h2 class="text-2xl font-black italic text-left" data-i18n="title_my_groups">Mis Grupos</h2>
                <div id="html-groups-list" class="space-y-3"></div>
            </div>

            <div id="view-group-detail" class="hidden space-y-6">
                <div class="flex items-center justify-between">
                    <button onclick="hideGroupDetail()" class="text-[10px] font-black text-slate-500 uppercase"><i
                            class="fas fa-arrow-left mr-1"></i> <span data-i18n="btn_back">Volver</span></button>
                    <span id="label-group-name"
                        class="text-[10px] font-black text-indigo-400 italic uppercase tracking-widest"
                        data-i18n="label_group">Grupo</span>
                </div>
                <div class="card-dark p-4 rounded-[2rem] shadow-xl">
                    <div class="flex justify-between items-center mb-4 px-2">
                        <button onclick="changeMonth(-1)" class="text-slate-400 p-2"><i
                                class="fas fa-chevron-left text-xs"></i></button>
                        <h3 id="calendar-month-title" class="font-black uppercase text-sm text-white text-center">Enero
                            2026</h3>
                        <button onclick="changeMonth(1)" class="text-slate-400 p-2"><i
                                class="fas fa-chevron-right text-xs"></i></button>
                    </div>
                    <div class="calendar-grid text-[8px] text-slate-600 text-center font-black mb-2 uppercase">
                        <div>LU</div>
                        <div>MA</div>
                        <div>MI</div>
                        <div>JU</div>
                        <div>VI</div>
                        <div>SA</div>
                        <div>DO</div>
                    </div>
                    <div id="calendar-body" class="calendar-grid"></div>
                </div>
                <div id="day-info" class="space-y-4">
                    <div class="flex justify-between items-center px-1">
                        <h4 id="selected-date-text"
                            class="text-[10px] font-black text-slate-500 uppercase tracking-widest italic"
                            data-i18n="label_select_day">Selecciona un
                            día</h4>
                        <div class="flex items-center gap-2">
                            <button onclick="refreshCalendar(true)"
                                class="bg-slate-800 text-slate-300 p-2 rounded-lg text-[9px] font-black uppercase border border-slate-700 hover:bg-slate-700 transition-all">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button id="btn-add-trip" onclick="openTripModal()"
                                class="hidden bg-indigo-600 text-[9px] px-4 py-2 rounded-full font-black uppercase shadow-lg"
                                data-i18n="btn_add_trip">+
                                Viaje</button>
                        </div>
                    </div>
                    <div id="list-trips-day" class="space-y-4"></div>
                    <button onclick="showGroupMembers()"
                        class="w-full mt-6 bg-slate-800 text-slate-300 py-3 rounded-xl text-[10px] font-black uppercase border border-slate-700">
                        <i class="fas fa-users mr-2"></i> <span data-i18n="btn_see_members">Ver Miembros</span>
                    </button>
                </div>
            </div>

            <div id="view-group-members" class="hidden space-y-6">
                <div class="flex items-center justify-between">
                    <button onclick="hideGroupMembers()" class="text-[10px] font-black text-slate-500 uppercase"><i
                            class="fas fa-arrow-left mr-1"></i> <span data-i18n="btn_back">Volver</span></button>
                    <span class="text-[10px] font-black text-indigo-400 italic uppercase tracking-widest"
                        data-i18n="title_members">Miembros</span>
                </div>
                <div id="html-members-list" class="space-y-3">
                    <!-- Members will be rendered here -->
                </div>
            </div>
        </section>

        <section id="tab-opciones" class="hidden space-y-6 text-center">
            <h2 class="text-2xl font-black italic text-left" data-i18n="title_settings">Ajustes</h2>
            <div class="card-dark p-8 rounded-[2rem] space-y-6 shadow-xl">
                <div class="space-y-2">
                    <p class="text-[10px] font-black text-slate-500 uppercase text-left ml-2"
                        data-i18n="label_public_name">Tu Nombre Público</p>
                    <div class="flex gap-2">
                        <input type="text" id="user-display-name"
                            class="flex-1 p-4 bg-slate-900 rounded-2xl border-none text-white text-sm"
                            placeholder="Tu nombre" data-i18n="placeholder_your_name">
                        <button onclick="updateProfileName()"
                            class="bg-indigo-600 w-14 rounded-2xl flex items-center justify-center text-white">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
                <div class="flex justify-between items-center bg-slate-900/50 p-4 rounded-2xl border border-slate-800">
                    <p class="text-xs font-black uppercase text-slate-300" data-i18n="label_has_car">Aporto Coche</p>
                    <input type="checkbox" id="user-has-car" onchange="updateCarStatus()"
                        class="w-6 h-6 accent-indigo-500">
                </div>
                <div class="space-y-2">
                    <p class="text-[10px] font-black text-slate-500 uppercase text-left ml-2"
                        data-i18n="label_language">Idioma</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="setLanguage('es')"
                            class="btn-selector p-3 rounded-xl bg-slate-900 text-slate-400 text-[10px] font-black uppercase border border-slate-800 transition-all"
                            id="lang-es">Castellano</button>
                        <button onclick="setLanguage('eu')"
                            class="btn-selector p-3 rounded-xl bg-slate-900 text-slate-400 text-[10px] font-black uppercase border border-slate-800 transition-all"
                            id="lang-eu">Euskera</button>
                    </div>
                </div>
                <div class="pt-4 space-y-4">
                    <button onclick="openManageGroupsModal()"
                        class="w-full bg-red-500/10 text-red-500 py-4 rounded-xl text-[10px] font-black uppercase border border-red-500/20">
                        <i class="fas fa-exchange-alt mr-2"></i> <span data-i18n="btn_manage_groups">Salir de un
                            Grupo</span>
                    </button>
                    <button onclick="logout()" class="w-full text-xs font-bold text-slate-500 uppercase underline"
                        data-i18n="btn_logout">Cerrar Sesión</button>
                </div>
            </div>
        </section>
    </main>

    <nav id="nav-bar" class="nav-bar hidden">
        <button onclick="switchTab('inicio')" id="nav-inicio" class="flex flex-col items-center gap-1 text-slate-500">
            <i id="nav-inicio-icon" class="fas fa-compass text-xl"></i>
            <span id="nav-inicio-text" class="text-[10px] font-black uppercase tracking-wider hidden">Inicio</span>
        </button>
        <button onclick="switchTab('grupos')" id="nav-grupos" class="flex flex-col items-center gap-1 text-slate-500">
            <i id="nav-grupos-icon" class="fas fa-car-side text-xl"></i>
            <span id="nav-grupos-text" class="text-[10px] font-black uppercase tracking-wider hidden">Grupos</span>
        </button>
        <button onclick="switchTab('opciones')" id="nav-opciones"
            class="flex flex-col items-center gap-1 text-slate-500">
            <i id="nav-opciones-icon" class="fas fa-sliders-h text-xl"></i>
            <span id="nav-opciones-text" class="text-[10px] font-black uppercase tracking-wider hidden">Ajustes</span>
        </button>
    </nav>

    <div id="modal-trip"
        class="hidden fixed inset-0 bg-slate-950/95 backdrop-blur-md flex items-center justify-center p-6 z-50">
        <div class="card-dark w-full max-w-sm p-8 rounded-[2.5rem] space-y-6 border border-slate-700">
            <h3 class="text-center font-black italic text-indigo-400 uppercase" data-i18n="modal_title_trip">Nuevo Viaje
            </h3>
            <div class="space-y-6 text-left">
                <div>
                    <label class="text-[9px] font-black text-slate-500 uppercase ml-2 mb-3 block"
                        data-i18n="label_type">Trayecto</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" class="btn-selector active" onclick="selectTripType('ida_vuelta', event)"
                            data-i18n="type_ida_vuelta">Ida y Vuelta</button>
                        <button type="button" class="btn-selector" onclick="selectTripType('ida', event)"
                            data-i18n="type_ida">Solo
                            Ida</button>
                        <button type="button" class="btn-selector" onclick="selectTripType('vuelta', event)"
                            data-i18n="type_vuelta">Solo
                            Vuelta</button>
                    </div>
                </div>
                <div>
                    <label class="text-[9px] font-black text-slate-500 uppercase ml-2 mb-3 block"
                        data-i18n="label_repeat">Repetición</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" class="btn-selector active" onclick="selectTripRepeat(0, event)"
                            data-i18n="repeat_none">Solo
                            hoy</button>
                        <button type="button" class="btn-selector" onclick="selectTripRepeat(4, event)"
                            data-i18n="repeat_4">4
                            semanas</button>
                        <button type="button" class="btn-selector" onclick="selectTripRepeat(12, event)"
                            data-i18n="repeat_12">12
                            semanas</button>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 pt-2">
                <button onclick="closeTripModal()" class="flex-1 text-xs font-bold text-slate-500 uppercase"
                    data-i18n="btn_cancel">Cancelar</button>
                <button id="btn-confirm-trip" onclick="confirmTripCreation()"
                    class="flex-1 bg-indigo-600 py-4 rounded-2xl font-black text-xs uppercase shadow-lg shadow-indigo-600/30"
                    data-i18n="btn_create">Crear</button>
            </div>
        </div>
    </div>

    <!-- Modal de Gestión de Grupos -->
    <div id="modal-manage-groups"
        class="hidden fixed inset-0 bg-slate-950/95 backdrop-blur-md flex items-center justify-center p-6 z-50">
        <div class="card-dark w-full max-w-sm p-8 rounded-[2.5rem] space-y-6 border border-slate-700">
            <h3 class="text-center font-black italic text-indigo-400 uppercase" data-i18n="modal_title_manage">Mis
                Grupos</h3>
            <div id="list-manage-groups" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                <!-- Groups to leave will be listed here -->
            </div>
            <div class="pt-2">
                <button onclick="closeManageGroupsModal()"
                    class="w-full py-4 text-xs font-bold text-slate-500 uppercase" data-i18n="btn_close">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación Personalizado -->
    <div id="modal-confirm"
        class="hidden fixed inset-0 bg-slate-950/95 backdrop-blur-md flex items-center justify-center p-6 z-[100]">
        <div class="card-dark w-full max-w-sm p-8 rounded-[2.5rem] space-y-6 border border-slate-700 text-center">
            <i id="confirm-icon" class="fas fa-question-circle text-4xl text-indigo-500"></i>
            <p id="confirm-text" class="text-sm font-bold text-slate-200"></p>
            <div class="flex gap-3 pt-2">
                <button id="confirm-cancel" class="flex-1 text-xs font-bold text-slate-500 uppercase"
                    data-i18n="btn_cancel">Utzi</button>
                <button id="confirm-ok"
                    class="flex-1 bg-indigo-600 py-4 rounded-2xl font-black text-xs uppercase shadow-lg shadow-indigo-600/30"
                    data-i18n="btn_confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
</body>

</html>